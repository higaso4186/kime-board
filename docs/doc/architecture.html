<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kimeboard GCP Architecture Detail</title>
    <style>
      :root {
        --bg: #f5f7fb;
        --surface: #ffffff;
        --ink: #0f172a;
        --muted: #334155;
        --line: #d6deeb;
        --active-bg: #ecfeff;
        --active-bd: #67e8f9;
        --opt-bg: #fff7ed;
        --opt-bd: #fdba74;
        --plan-bg: #eef2ff;
        --plan-bd: #a5b4fc;
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter", "Noto Sans JP", sans-serif;
        color: var(--ink);
        background: linear-gradient(180deg, #eef2ff 0%, #f8fafc 32%, #eff6ff 100%);
      }
      .wrap {
        max-width: 1500px;
        margin: 0 auto;
        padding: 24px;
        display: grid;
        gap: 18px;
      }
      .card {
        background: var(--surface);
        border: 1px solid var(--line);
        border-radius: 16px;
        padding: 18px;
        box-shadow: 0 12px 30px rgba(15, 23, 42, 0.06);
      }
      h1, h2, h3 { margin: 0 0 10px; }
      p { margin: 0; color: var(--muted); line-height: 1.7; }
      .tag {
        display: inline-block;
        border: 1px solid #bfdbfe;
        background: #eff6ff;
        color: #1d4ed8;
        font-weight: 700;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 12px;
        margin-bottom: 8px;
      }
      .legend {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .legend span {
        border: 1px solid var(--line);
        border-radius: 999px;
        padding: 5px 10px;
        font-size: 12px;
        color: #334155;
        background: #fff;
      }
      .grid2 {
        display: grid;
        gap: 16px;
        grid-template-columns: 1fr 1fr;
      }
      .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }
      th, td {
        border-bottom: 1px solid #e2e8f0;
        text-align: left;
        padding: 10px 8px;
        vertical-align: top;
      }
      th { background: #f8fafc; }
      @media (max-width: 980px) {
        .grid2 { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <section class="card">
        <span class="tag">Kimeboard / Architecture</span>
        <h1>GCPサービス詳細設計図（MVP 現在地）</h1>
        <p>
          「今ある実装」と「infra 仕様で想定している構成」を、GCPサービス単位で分解した図です。
          色は <b>稼働中 / 任意 / 計画</b> を表します。
        </p>
      </section>

      <section class="card">
        <h2>全体トポロジ（サービス粒度）</h2>
        <svg id="gcp-map" viewBox="0 0 1680 980" width="100%" role="img" aria-label="GCP architecture detailed map">
          <defs>
            <marker id="arr" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L9,3 L0,6 z" fill="#64748b"></path>
            </marker>
            <marker id="arr2" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
              <path d="M0,0 L9,3 L0,6 z" fill="#334155"></path>
            </marker>
          </defs>

          <rect x="10" y="10" width="1660" height="960" rx="18" fill="#ffffff" stroke="#d6deeb"></rect>

          <rect x="36" y="45" width="260" height="120" rx="12" fill="#eff6ff" stroke="#93c5fd"></rect>
          <text x="55" y="77" font-size="16" font-weight="700" fill="#1e3a8a">利用者 / ブラウザ</text>
          <text x="55" y="101" font-size="13" fill="#334155">PM・決裁者・管理職</text>
          <text x="55" y="121" font-size="13" fill="#334155">Web UI / API 呼び出し</text>
          <text x="55" y="141" font-size="13" fill="#334155">運用者は gcloud / terraform 実行</text>

          <rect x="330" y="30" width="1310" height="280" rx="14" fill="#f8fafc" stroke="#cbd5e1"></rect>
          <text x="350" y="58" font-size="16" font-weight="700" fill="#0f172a">Edge & Routing</text>

          <rect x="360" y="80" width="180" height="95" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="375" y="110" font-size="14" font-weight="700" fill="#155e75">Cloud DNS</text>
          <text x="375" y="132" font-size="12" fill="#334155">mvp / api-mvp</text>
          <text x="375" y="149" font-size="12" fill="#334155">A/CNAME records</text>

          <rect x="560" y="80" width="215" height="95" rx="10" fill="#fff7ed" stroke="#fdba74"></rect>
          <text x="576" y="110" font-size="14" font-weight="700" fill="#9a3412">Certificate Manager</text>
          <text x="576" y="132" font-size="12" fill="#334155">Managed cert (Pattern B)</text>
          <text x="576" y="149" font-size="12" fill="#334155">証明書ライフサイクル</text>

          <rect x="800" y="80" width="290" height="95" rx="10" fill="#fff7ed" stroke="#fdba74"></rect>
          <text x="816" y="110" font-size="14" font-weight="700" fill="#9a3412">Global HTTPS Load Balancer</text>
          <text x="816" y="132" font-size="12" fill="#334155">URL Map / TLS終端</text>
          <text x="816" y="149" font-size="12" fill="#334155">単一ドメインで /api 分岐時に利用</text>

          <rect x="1120" y="80" width="230" height="95" rx="10" fill="#fff7ed" stroke="#fdba74"></rect>
          <text x="1136" y="110" font-size="14" font-weight="700" fill="#9a3412">Serverless NEG</text>
          <text x="1136" y="132" font-size="12" fill="#334155">web NEG / api NEG</text>
          <text x="1136" y="149" font-size="12" fill="#334155">LBバックエンド接続</text>

          <rect x="1380" y="80" width="240" height="95" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="1395" y="110" font-size="14" font-weight="700" fill="#155e75">Cloud Run Domain Mapping</text>
          <text x="1395" y="132" font-size="12" fill="#334155">Pattern A 推奨:</text>
          <text x="1395" y="149" font-size="12" fill="#334155">mvp / api-mvp 分離</text>

          <rect x="360" y="200" width="1260" height="90" rx="10" fill="#eef2ff" stroke="#a5b4fc" stroke-dasharray="8 6"></rect>
          <text x="380" y="228" font-size="14" font-weight="700" fill="#3730a3">Routing Strategy</text>
          <text x="380" y="250" font-size="12" fill="#334155">Pattern A（稼働推奨）: Web= mvp.domain, API= api-mvp.domain</text>
          <text x="380" y="268" font-size="12" fill="#334155">Pattern B（任意）: 単一ドメイン + LB + NEG + URL map</text>

          <rect x="330" y="340" width="1310" height="350" rx="14" fill="#f8fafc" stroke="#cbd5e1"></rect>
          <text x="350" y="368" font-size="16" font-weight="700" fill="#0f172a">Application Plane (Cloud Run + Async + Data)</text>

          <rect x="360" y="405" width="250" height="110" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="378" y="433" font-size="14" font-weight="700" fill="#155e75">Cloud Run: web</text>
          <text x="378" y="455" font-size="12" fill="#334155">Service: kimeboard-web-mvp</text>
          <text x="378" y="473" font-size="12" fill="#334155">Next.js UI</text>
          <text x="378" y="491" font-size="12" fill="#334155">ENV: NEXT_PUBLIC_API_BASE_URL</text>

          <rect x="640" y="405" width="290" height="170" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="658" y="433" font-size="14" font-weight="700" fill="#155e75">Cloud Run: api</text>
          <text x="658" y="455" font-size="12" fill="#334155">Service: kimeboard-api-mvp</text>
          <text x="658" y="473" font-size="12" fill="#334155">Next Route Handlers + shared schemas</text>
          <text x="658" y="491" font-size="12" fill="#334155">Firestore CRUD / Cloud Tasks enqueue</text>
          <text x="658" y="509" font-size="12" fill="#334155">Internal callback endpoint</text>
          <text x="658" y="527" font-size="12" fill="#334155">Secret: AGENT_CALLBACK_TOKEN</text>
          <text x="658" y="545" font-size="12" fill="#334155">Secret: API_INTERNAL_TOKEN</text>

          <rect x="970" y="405" width="250" height="150" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="988" y="433" font-size="14" font-weight="700" fill="#155e75">Cloud Run: agent</text>
          <text x="988" y="455" font-size="12" fill="#334155">Service: kimeboard-agent-mvp</text>
          <text x="988" y="473" font-size="12" fill="#334155">FastAPI tasks</text>
          <text x="988" y="491" font-size="12" fill="#334155">meeting/reply/actions workflows</text>
          <text x="988" y="509" font-size="12" fill="#334155">Secret: VERTEX_MODEL</text>
          <text x="988" y="527" font-size="12" fill="#334155">Secret: AGENT_CALLBACK_TOKEN</text>

          <rect x="1260" y="405" width="350" height="120" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="1278" y="433" font-size="14" font-weight="700" fill="#155e75">Cloud Tasks: agent-queue-mvp</text>
          <text x="1278" y="455" font-size="12" fill="#334155">max_dispatches_per_second=2</text>
          <text x="1278" y="473" font-size="12" fill="#334155">max_concurrent_dispatches=1</text>
          <text x="1278" y="491" font-size="12" fill="#334155">OIDC invoker to agent endpoint</text>

          <rect x="640" y="600" width="260" height="72" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="658" y="627" font-size="14" font-weight="700" fill="#155e75">Firestore (Native)</text>
          <text x="658" y="648" font-size="12" fill="#334155">project/meeting/decision/action/thread/message</text>

          <rect x="930" y="600" width="230" height="72" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="948" y="627" font-size="14" font-weight="700" fill="#155e75">Secret Manager</text>
          <text x="948" y="648" font-size="12" fill="#334155">MVP_CONFIG, API_INTERNAL_TOKEN, ...</text>

          <rect x="1190" y="600" width="210" height="72" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="1208" y="627" font-size="14" font-weight="700" fill="#155e75">Artifact Registry</text>
          <text x="1208" y="648" font-size="12" fill="#334155">Docker images: web/api/agent</text>

          <rect x="1430" y="600" width="180" height="72" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="1447" y="627" font-size="14" font-weight="700" fill="#155e75">Cloud Logging</text>
          <text x="1447" y="648" font-size="12" fill="#334155">Run logs / task traces</text>

          <rect x="330" y="720" width="1310" height="220" rx="14" fill="#f8fafc" stroke="#cbd5e1"></rect>
          <text x="350" y="748" font-size="16" font-weight="700" fill="#0f172a">Provisioning & Governance Plane</text>

          <rect x="360" y="780" width="350" height="125" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="380" y="808" font-size="14" font-weight="700" fill="#155e75">Terraform (infra/terraform)</text>
          <text x="380" y="830" font-size="12" fill="#334155">module.foundation / module.db / module.adk</text>
          <text x="380" y="848" font-size="12" fill="#334155">module.cloud_run (optional count)</text>
          <text x="380" y="866" font-size="12" fill="#334155">component apply + all apply</text>
          <text x="380" y="884" font-size="12" fill="#334155">state: remote backend想定（後続）</text>

          <rect x="740" y="780" width="260" height="125" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="760" y="808" font-size="14" font-weight="700" fill="#155e75">gcloud / ADC Auth</text>
          <text x="760" y="830" font-size="12" fill="#334155">glogin.ps1</text>
          <text x="760" y="848" font-size="12" fill="#334155">auth login + adc login</text>
          <text x="760" y="866" font-size="12" fill="#334155">active project set</text>

          <rect x="1030" y="780" width="270" height="125" rx="10" fill="#ecfeff" stroke="#67e8f9"></rect>
          <text x="1050" y="808" font-size="14" font-weight="700" fill="#155e75">IAM & Service Accounts</text>
          <text x="1050" y="830" font-size="12" fill="#334155">kimeboard-web/api/agent/cicd</text>
          <text x="1050" y="848" font-size="12" fill="#334155">run.invoker / datastore.user /</text>
          <text x="1050" y="866" font-size="12" fill="#334155">cloudtasks.enqueuer / secret accessor</text>

          <rect x="1330" y="780" width="280" height="125" rx="10" fill="#eef2ff" stroke="#a5b4fc"></rect>
          <text x="1348" y="808" font-size="14" font-weight="700" fill="#3730a3">CI/CD (next step)</text>
          <text x="1348" y="830" font-size="12" fill="#334155">GitHub Actions / Cloud Build</text>
          <text x="1348" y="848" font-size="12" fill="#334155">image build + terraform plan/apply</text>
          <text x="1348" y="866" font-size="12" fill="#334155">production rollout test is not enabled</text>

          <line x1="296" y1="105" x2="360" y2="105" stroke="#64748b" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="540" y1="128" x2="560" y2="128" stroke="#64748b" stroke-width="1.8" marker-end="url(#arr)"></line>
          <line x1="776" y1="128" x2="800" y2="128" stroke="#64748b" stroke-width="1.8" marker-end="url(#arr)"></line>
          <line x1="1092" y1="128" x2="1120" y2="128" stroke="#64748b" stroke-width="1.8" marker-end="url(#arr)"></line>
          <line x1="1350" y1="128" x2="1380" y2="128" stroke="#64748b" stroke-width="1.8" marker-end="url(#arr)"></line>

          <line x1="500" y1="288" x2="500" y2="405" stroke="#64748b" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="750" y1="288" x2="780" y2="405" stroke="#64748b" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1540" y1="288" x2="1110" y2="405" stroke="#64748b" stroke-width="2.2" marker-end="url(#arr2)"></line>

          <line x1="610" y1="460" x2="640" y2="460" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="930" y1="460" x2="970" y2="460" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="930" y1="500" x2="1260" y2="465" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1380" y1="525" x2="1095" y2="555" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1095" y1="555" x2="785" y2="575" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="785" y1="575" x2="785" y2="600" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1045" y1="555" x2="1045" y2="600" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1295" y1="525" x2="1295" y2="600" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>
          <line x1="1518" y1="525" x2="1518" y2="600" stroke="#334155" stroke-width="2.2" marker-end="url(#arr2)"></line>

          <line x1="520" y1="905" x2="520" y2="720" stroke="#64748b" stroke-width="2" marker-end="url(#arr)"></line>
          <line x1="870" y1="905" x2="870" y2="720" stroke="#64748b" stroke-width="2" marker-end="url(#arr)"></line>
          <line x1="1165" y1="905" x2="1165" y2="720" stroke="#64748b" stroke-width="2" marker-end="url(#arr)"></line>
          <line x1="1470" y1="905" x2="1295" y2="672" stroke="#64748b" stroke-width="2" marker-end="url(#arr)"></line>

          <text x="620" y="447" font-size="12" fill="#334155">UI call</text>
          <text x="938" y="447" font-size="12" fill="#334155">enqueue</text>
          <text x="1222" y="444" font-size="12" fill="#334155">task dispatch</text>
          <text x="1098" y="543" font-size="12" fill="#334155">callback</text>
          <text x="788" y="592" font-size="12" fill="#334155">data write/read</text>
        </svg>
        <div class="legend">
          <span style="background: var(--active-bg); border-color: var(--active-bd);">稼働中 / 実装済み</span>
          <span style="background: var(--opt-bg); border-color: var(--opt-bd);">任意構成（有効化で利用）</span>
          <span style="background: var(--plan-bg); border-color: var(--plan-bd);">計画中 / 次フェーズ</span>
        </div>
      </section>

      <section class="grid2">
        <div class="card">
          <h2>Terraform モジュールと GCP サービス対応</h2>
          <table>
            <thead>
              <tr><th>module</th><th>GCP サービス</th><th>状態</th><th>目的</th></tr>
            </thead>
            <tbody>
              <tr>
                <td><span class="mono">foundation</span></td>
                <td>Service Usage, IAM, Service Accounts, Secret Manager, Artifact Registry</td>
                <td>稼働中</td>
                <td>基盤初期化・権限設計・シークレット管理</td>
              </tr>
              <tr>
                <td><span class="mono">db</span></td>
                <td>Firestore Native</td>
                <td>稼働中</td>
                <td>ドメインデータ永続化</td>
              </tr>
              <tr>
                <td><span class="mono">adk</span></td>
                <td>Cloud Tasks</td>
                <td>稼働中</td>
                <td>API→Agent の非同期実行制御</td>
              </tr>
              <tr>
                <td><span class="mono">cloud_run</span></td>
                <td>Cloud Run, Run IAM</td>
                <td>任意（default off）</td>
                <td>web/api/agent サービス定義と接続</td>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="card">
          <h2>ネットワーク公開パターン</h2>
          <h3>A. 推奨（分離ドメイン）</h3>
          <p>
            <span class="mono">mvp.&lt;apex&gt;</span> → web, <span class="mono">api-mvp.&lt;apex&gt;</span> → api。
            構成が最小で運用が単純。
          </p>
          <h3 style="margin-top: 12px;">B. 単一ドメイン拘り</h3>
          <p>
            LB + NEG + URL map で <span class="mono">/api</span> 分岐。証明書・ルーティング管理は強化されるが構成が重い。
          </p>
          <h2 style="margin-top: 14px;">運用コマンド</h2>
          <p class="mono">./infra/scripts/glogin.ps1 -ProjectId &lt;PROJECT&gt;</p>
          <p class="mono">./infra/scripts/infra.ps1 -Action apply -Component db -ProjectId &lt;PROJECT&gt;</p>
          <p class="mono">./infra/scripts/infra.ps1 -Action apply -Component all -ProjectId &lt;PROJECT&gt;</p>
        </div>
      </section>

      <section class="card">
        <h2>実行時シーケンス（サービス名付き）</h2>
        <table>
          <thead>
            <tr><th>Step</th><th>実行主体</th><th>GCP サービス</th><th>処理</th></tr>
          </thead>
          <tbody>
            <tr><td>1</td><td>ユーザー</td><td>Cloud Run (web)</td><td>会議メモ登録UI操作</td></tr>
            <tr><td>2</td><td>web</td><td>Cloud Run (api)</td><td><span class="mono">POST /api/projects/{projectId}/meetings</span></td></tr>
            <tr><td>3</td><td>api</td><td>Firestore</td><td>Meeting作成（ANALYZING）</td></tr>
            <tr><td>4</td><td>api</td><td>Cloud Tasks</td><td><span class="mono">meeting_structurer</span> enqueue（OIDC）</td></tr>
            <tr><td>5</td><td>Cloud Tasks</td><td>Cloud Run (agent)</td><td>Task HTTP dispatch</td></tr>
            <tr><td>6</td><td>agent</td><td>Cloud Run (api)</td><td>internal callback で抽出結果反映</td></tr>
            <tr><td>7</td><td>api</td><td>Firestore</td><td>Decision/Thread/Message/Action更新</td></tr>
            <tr><td>8</td><td>all</td><td>Cloud Logging</td><td>処理ログ集約</td></tr>
          </tbody>
        </table>
      </section>
    </div>
  </body>
</html>
